name: Build and release Aseprite With Version

on:
  push:
    branches:
      - main
    paths:
      - 'BuildLog.md'
  workflow_dispatch:
    inputs:
      aseprite_version:
        description: '指定要编译的Aseprite版本号（如 v1.3.16）（参考https://github.com/aseprite/aseprite/tags）'
        required: true
        default: 'v1.3.16.1'

env:
  BUILD_TYPE: Release
  SKIA_VERSION: m124-08a5439a6b  # 适配1.3.x版本的Skia
  ASEPRITE_REPO: https://github.com/aseprite/aseprite.git

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release-tag: ${{ github.event.inputs.aseprite_version }}
    steps:
      - uses: actions/checkout@v4
      - name: Create empty release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.event.inputs.aseprite_version }}
          body: "Aseprite ${{ github.event.inputs.aseprite_version }} 编译版本"
          draft: true
          skipIfReleaseExists: true
          token: ${{ secrets.GITHUB_TOKEN }}

  build-aseprite:
    name: Build Aseprite (${{ matrix.os }})
    needs: create-release
    permissions:
      contents: write
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]  # 先只编译Windows（最稳定），macOS/Linux可后续添加
      fail-fast: false

    steps:
      - name: 配置Windows环境
        if: runner.os == 'Windows'
        run: |
          # 禁用CCache避免干扰
          echo "CCACHE_DISABLE=1" >> $GITHUB_ENV
          # 安装必要依赖
          choco install -y ninja 7zip wget

      - name: 克隆Aseprite源码（带子模块）
        run: |
          git clone --depth 1 --branch ${{ needs.create-release.outputs.release-tag }} --recurse-submodules ${{ env.ASEPRITE_REPO }} aseprite
          cd aseprite
          # 修复第三方依赖路径（关键：初始化所有子模块）
          git submodule update --init --recursive third_party
          git submodule update --init --recursive laf/third_party

      - name: 下载并解压Skia
        working-directory: aseprite
        run: |
          # 下载对应版本的Skia预编译包
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            SKIA_URL="https://github.com/aseprite/skia/releases/download/${{ env.SKIA_VERSION }}/Skia-Windows-Release-x64.zip"
            SKIA_DIR="./skia"
            wget --no-check-certificate $SKIA_URL -O skia.zip
            7z x skia.zip -o$SKIA_DIR -y
          fi

      - name: 配置MSVC编译环境
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: CMake配置（修复依赖路径+启用Skia）
        working-directory: aseprite
        run: |
          mkdir -p build
          cd build
          
          # 核心：正确指定Skia路径+禁用不必要的依赖检查+启用Skia后端
          cmake -G Ninja .. ^
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ^
            -DCMAKE_CXX_FLAGS="/DWIN32 /D_WINDOWS /W3 /GR /EHsc" ^
            -DLAF_BACKEND=skia ^
            -DSKIA_DIR=%cd%/../skia ^
            -DSKIA_LIBRARY_DIR=%cd%/../skia/out/Release-x64 ^
            -DSKIA_LIBRARY=%cd%/../skia/out/Release-x64/skia.lib ^
            -DENABLE_CCACHE=OFF ^
            -DENABLE_TESTS=OFF ^
            -DENABLE_SCRIPTING=ON ^
            -DOPENSSL_USE_STATIC_LIBS=ON ^
            -DCMAKE_IGNORE_PATH=C:/Strawberry/c/bin  # 排除Strawberry Perl的CCache干扰

      - name: 编译Aseprite
        working-directory: aseprite/build
        run: ninja aseprite

      - name: 打包编译产物
        working-directory: aseprite/build/bin
        run: |
          # 创建便携版标识文件
          echo "# Portable mode" > aseprite.ini
          # 只保留必要文件（减小体积）
          rm -rf *.pdb *.lib *.exp 2>nul || true
          # 打包成ZIP
          7z a Aseprite-${{ needs.create-release.outputs.release-tag }}-Windows-x64.zip * -mx9

      - name: 上传编译产物到Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: aseprite/build/bin/Aseprite-${{ needs.create-release.outputs.release-tag }}-Windows-x64.zip
          asset_name: Aseprite-${{ needs.create-release.outputs.release-tag }}-Windows-x64.zip
          tag: ${{ needs.create-release.outputs.release-tag }}
          overwrite: true
          body: "Windows x64 编译版本 | Aseprite ${{ needs.create-release.outputs.release-tag }}"
